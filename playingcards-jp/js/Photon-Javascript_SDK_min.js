var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),Exitgames,Photon;(function(n){var t;(function(n){var i=function(){function n(t,i){t===void 0&&(t="");i===void 0&&(i=n.Level.INFO);this.prefix=t;this.level=i}return n.prototype.setLevel=function(t){t=Math.max(t,n.Level.DEBUG);t=Math.min(t,n.Level.OFF);this.level=t},n.prototype.isLevelEnabled=function(n){return n>=this.level},n.prototype.getLevel=function(){return this.level},n.prototype.debug=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.log(n.Level.DEBUG,t,r)},n.prototype.info=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.log(n.Level.INFO,t,r)},n.prototype.warn=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.log(n.Level.WARN,t,r)},n.prototype.error=function(t){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.log(n.Level.ERROR,t,r)},n.prototype.format=function(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];return this.format0(n,i)},n.prototype.formatArr=function(n,t){return this.format0(n,t)},n.prototype.log=function(t,i,r){if(t>=this.level&&typeof console!="undefined"&&i!==undefined)try{var u=console[n.log_types[t]];u||(u=console.log);u&&u.apply(console,[this.prefix,i].concat(r))}catch(f){}},n.prototype.format0=function(n,t){return(this.prefix==""?"":this.prefix+" ")+n+" "+t.map(function(n){if(n!==undefined)switch(typeof n){case"object":try{return JSON.stringify(n)}catch(t){return n.toString()+"("+t+")"}default:return n.toString()}}).join(" ")},n.Level={DEBUG:1,INFO:2,WARN:3,ERROR:4,OFF:6},n.log_types=["debug","debug","info","warn","error"],n}(),t;n.Logger=i;t=function(){function n(){}return n.indexOf=function(n,t,i){for(var u=n.length,r=i<0?Math.max(0,u+i):i||0;r<u;r++)if(n[r]===t)return r;return-1},n.isArray=function(n){return Object.prototype.toString.call(n)==="[object Array]"},n.merge=function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n.getPropertyOrElse=function(n,t,i){return n.hasOwnProperty(t)?n[t]:i},n.enumValueToName=function(n,t){for(var i in n)if(t==n[i])return i;return"undefined"},n.getEnumKeyByValue=function(n,t){for(var i in n)if(t==n[i])return i;return undefined},n}();n.Util=t})(t=n.Common||(n.Common={}))})(Exitgames||(Exitgames={})),function(n){var t,i;n.ConnectionProtocol={Ws:0,Wss:1};t=function(){function n(){}return n.Byte=function(n){return n},n.Short=function(n){return n},n.Int=function(n){return n},n.Long=function(n){return n},n.Float=function(n){return n},n.Double=function(n){return n},n.String=function(n){return n},n}();n.TypeExt=t;i=function(){function n(n,t,i){t===void 0&&(t="");i===void 0&&(i="");this.url=n;this.subprotocol=t;this.keepAliveTimeoutMs=3e3;this._frame="~m~";this._isConnecting=!1;this._isConnected=!1;this._isClosing=!1;this._peerStatusListeners={};this._eventListeners={};this._responseListeners={};this.lastRtt=0;this.initTimestamp=Date.now();this.keepAliveTimer=0;this._logger=new Exitgames.Common.Logger(i&&i!=""?i+":":"")}return n.prototype.isConnecting=function(){return this._isConnecting},n.prototype.getLastRtt=function(){return this.lastRtt},n.prototype.isConnected=function(){return this._isConnected},n.prototype.isClosing=function(){return this._isClosing},n.prototype.connect=function(){var n=this;this._sessionid=undefined;this._socket=this.subprotocol==""?new WebSocket(this.url,"Json"):new WebSocket(this.url,this.subprotocol);this._onConnecting();this._socket.onopen=function(){};this._socket.onmessage=function(t){var i=n._decode(t.data);n._onMessage(i.toString())};this._socket.onclose=function(t){n._logger.debug("onclose: wasClean =",t.wasClean,", code=",t.code,", reason =",t.reason);n._isConnecting?n._onConnectFailed(t):(1006==t.code&&n._onTimeout(),n._onDisconnect())};this._socket.onerror=function(t){n._onError(t)}},n.prototype.disconnect=function(){this._isClosing=!0;this._socket.close()},n.prototype.sendOperation=function(n,t,i,r){i===void 0&&(i=!1);r===void 0&&(r=0);var u={req:n,vals:[]};if(Exitgames.Common.Util.isArray(t))u.vals=t;else if(t===undefined)u.vals=[];else throw new Error(this._logger.format("PhotonPeer[sendOperation] - Trying to send non array data:",t));this._send(u);this._logger.debug("PhotonPeer[sendOperation] - Sending request:",u)},n.prototype.addPeerStatusListener=function(n,t){this._addListener(this._peerStatusListeners,n,t)},n.prototype.addEventListener=function(n,t){this._addListener(this._eventListeners,n.toString(),t)},n.prototype.addResponseListener=function(n,t){this._addListener(this._responseListeners,n.toString(),t)},n.prototype.removePeerStatusListener=function(n,t){this._removeListener(this._peerStatusListeners,n,t)},n.prototype.removeEventListener=function(n,t){this._removeListener(this._eventListeners,n.toString(),t)},n.prototype.removeResponseListener=function(n,t){this._removeListener(this._responseListeners,n.toString(),t)},n.prototype.removePeerStatusListenersForCode=function(n){this._removeListenersForCode(this._peerStatusListeners,n)},n.prototype.removeEventListenersForCode=function(n){this._removeListenersForCode(this._eventListeners,n.toString())},n.prototype.removeResponseListenersForCode=function(n){this._removeListenersForCode(this._responseListeners,n.toString())},n.prototype.setLogLevel=function(n){this._logger.setLevel(n)},n.prototype.onUnhandledEvent=function(n){this._logger.warn("PhotonPeer: No handler for event",n,"registered.")},n.prototype.onUnhandledResponse=function(n){this._logger.warn("PhotonPeer: No handler for response",n,"registered.")},n.prototype._dispatchEvent=function(n,t){if(!this._dispatch(this._eventListeners,n.toString(),t,"event"))this.onUnhandledEvent(n,t)},n.prototype._dispatchResponse=function(n,t){if(!this._dispatch(this._responseListeners,n.toString(),t,"response"))this.onUnhandledResponse(n,t)},n.prototype._stringify=function(n){if(Object.prototype.toString.call(n)=="[object Object]"){if(!JSON)throw new Error("PhotonPeer[_stringify] - Trying to encode as JSON, but JSON.stringify is missing.");return"~j~"+JSON.stringify(n)}return String(n)},n.prototype._encode=function(n){for(var r="",i,n=Exitgames.Common.Util.isArray(n)?n:[n],t=0,u=n.length;t<u;t++)i=n[t]===null||n[t]===undefined?"":this._stringify(n[t]),r+=this._frame+i.length+this._frame+i;return r},n.prototype._decode=function(n){var u=[],t,r,f=n,o=n.indexOf("\x00"),i,e;o!==-1&&(f=n.replace(/[\0]/g,""));n=f;do{if(n.substr(0,3)!==this._frame)return u;for(n=n.substr(3),t="",r="",i=0,e=n.length;i<e;i++)if(r=Number(n.substr(i,1)),n.substr(i,1)==r)t+=r;else{n=n.substr(t.length+this._frame.length);t=Number(t);break}u.push(n.substr(0,t));n=n.substr(t)}while(n!=="");return u},n.prototype._onMessage=function(n){n.substr(0,3)=="~j~"?this._onMessageReceived(JSON.parse(n.substr(3))):this._sessionid?this._onMessageReceived(n):(this._sessionid=n,this._onConnect())},n.prototype.resetKeepAlive=function(){var n=this;clearTimeout(this.keepAliveTimer);this.keepAliveTimeoutMs>=1e3&&(this.keepAliveTimer=setTimeout(function(){n._send({irq:1,vals:[1,Date.now()-n.initTimestamp]},!0)},this.keepAliveTimeoutMs))},n.prototype._send=function(n,t){t===void 0&&(t=!1);var i=this._encode(n);if(this._isConnected&&!this._isClosing)this.resetKeepAlive(),this._socket.send(i);else if(!t)throw new Error(this._logger.format("PhotonPeer[_send] - Operation",n.req,'- failed, "isConnected" is',this._isConnected,', "isClosing" is',this._isClosing,"!"));},n.prototype._onMessageReceived=function(n){var t,r,i;if(typeof n=="object")if(this._logger.debug("PhotonPeer[_onMessageReceived] - Socket received message:",n),t=n,r=t.err?t.err:0,t.vals=t.vals!==undefined?t.vals:[],t.vals.length>0&&(t.vals=this._parseMessageValuesArrayToJSON(t.vals)),t.res!==undefined)i=parseInt(t.res),this._parseResponse(i,t);else if(t.evt!==undefined)i=parseInt(t.evt),this._parseEvent(i,t);else if(t.irs!==undefined)i=parseInt(t.irs),this._parseInternalResponse(i,t);else throw new Error(this._logger.format("PhotonPeer[_onMessageReceived] - Received undefined message type:",t));},n.prototype._parseMessageValuesArrayToJSON=function(n){var i={},t,r,u;if(Exitgames.Common.Util.isArray(n))if(n.length%2==0)for(t=n;t.length>0;)r=t.shift()+"",u=t.shift(),i[r]=u;else throw new Error(this._logger.format("PhotonPeer[_parseMessageValuesToJSON] - Received invalid values array:",n));return i},n.prototype._parseEvent=function(n,t){switch(n){default:this._dispatchEvent(n,{vals:t.vals})}},n.prototype._parseResponse=function(n,t){switch(n){default:this._dispatchResponse(n,{errCode:t.err,errMsg:t.msg,vals:t.vals})}},n.prototype._parseInternalResponse=function(n,t){this.lastRtt=Date.now()-this.initTimestamp-t.vals[1];this._logger.debug("internal response:",t)},n.prototype._onConnecting=function(){this._logger.debug("PhotonPeer[_onConnecting] - Starts connecting",this.url,'..., raising "connecting" event ...');this._isConnecting=!0;this._dispatchPeerStatus(n.StatusCodes.connecting);this.resetKeepAlive()},n.prototype._onConnect=function(){this._logger.debug('PhotonPeer[_onConnect] - Connected successfully! Raising "connect" event ...');this._isConnecting=!1;this._isConnected=!0;this._dispatchPeerStatus(n.StatusCodes.connect);this.resetKeepAlive()},n.prototype._onConnectFailed=function(){this._logger.error("PhotonPeer[_onConnectFailed] - Socket connection could not be created:",this.url,this.subprotocol,'Wrong host or port?\n Raising "connectFailed event ...');this._isConnecting=this._isConnected=!1;this._dispatchPeerStatus(n.StatusCodes.connectFailed)},n.prototype._onDisconnect=function(){var t=this._isConnected,i=this._isClosing;this._logger.debug('PhotonPeer[_onDisconnect] - Socket closed, raising "disconnect" event ...');this._isClosing=this._isConnected=this._isConnecting=!1;t&&(i?this._dispatchPeerStatus(n.StatusCodes.disconnect):this._dispatchPeerStatus(n.StatusCodes.connectClosed))},n.prototype._onTimeout=function(){this._logger.debug('PhotonPeer[_onTimeout] - Client timed out! Raising "timeout" event ...');this._dispatchPeerStatus(n.StatusCodes.timeout)},n.prototype._onError=function(){this._logger.error("PhotonPeer[_onError] - Connection error:",arguments[0]);this._isConnecting=this._isConnected=this._isClosing=!1;this._dispatchPeerStatus(n.StatusCodes.error)},n.prototype._addListener=function(n,t,i){return t in n||(n[t]=[]),i&&typeof i=="function"?(this._logger.debug("PhotonPeer[_addListener] - Adding listener for event",t),n[t].push(i)):this._logger.error("PhotonPeer[_addListener] - Listener",t,"is not a function but of type",typeof i,". No listener added!"),this},n.prototype._dispatch=function(n,t,i){var u,r,f;if(t in n){for(u=n[t],r=0,f=u.length;r<f;r++)Exitgames.Common.Util.isArray(i)||(i=[i]),u[r].apply(this,i===undefined?[]:i);return!0}return!1},n.prototype._dispatchPeerStatus=function(n){this._dispatch(this._peerStatusListeners,n,undefined,"peerStatus")||this._logger.warn("PhotonPeer[_dispatchPeerStatus] - No handler for ",n,"registered.")},n.prototype._removeListener=function(n,t,i){if(t in n){var r=n[t].length;n[t]=n[t].filter(function(n){return n!=i});this._logger.debug("PhotonPeer[_removeListener] - Removing listener for event",t,"removed:",r-n[t].length)}return this},n.prototype._removeListenersForCode=function(n,t){return this._logger.debug("PhotonPeer[_removeListenersForCode] - Removing all listeners for event",t),t in n&&(n[t]=[]),this},n.StatusCodes={connecting:"connecting",connect:"connect",connectFailed:"connectFailed",disconnect:"disconnect",connectClosed:"connectClosed",error:"error",timeout:"timeout"},n}();n.PhotonPeer=i}(Photon||(Photon={})),function(n){var t;(function(t){function e(t,r){for(var u in i)if(t.indexOf(i[u])==0)return t;switch(r){case n.ConnectionProtocol.Ws:return i.ws+t;case n.ConnectionProtocol.Wss:return i.wss+t;default:return i.ws+t}}var i={ws:"ws://",wss:"wss://"},r=function(){function n(n,t,i){this.name=n;this.actorNr=t;this.isLocal=i;this.customProperties={};this.suspended=!1}return n.prototype.getRoom=function(){return this.loadBalancingClient.myRoom()},n.prototype.raiseEvent=function(n,t,i){this.loadBalancingClient&&this.loadBalancingClient.raiseEvent(n,t,i)},n.prototype.setName=function(n){this.name=n},n.prototype.onPropertiesChange=function(){},n.prototype.getCustomProperty=function(n){return this.customProperties[n]},n.prototype.getCustomPropertyOrElse=function(n,t){return Exitgames.Common.Util.getPropertyOrElse(this.customProperties,n,t)},n.prototype.setCustomProperty=function(n,t,i,r){var u,e,f;i===void 0&&(i=!1);this.customProperties[n]=t;u={};u[n]=t;r!=undefined&&(e=(f={},f[n]=r,f));this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfActor(this.actorNr,u,i,e);this.onPropertiesChange(u,!0)},n.prototype.setCustomProperties=function(n,t,i){var u,r;t===void 0&&(t=!1);u={};for(r in n)this.customProperties[r]=n[r],u[r]=n[r];this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfActor(this.actorNr,u,t,i);this.onPropertiesChange(u,!0)},n.prototype.getJoinToken=function(){return this.joinToken},n.prototype.isSuspended=function(){return this.suspended},n.prototype._getAllProperties=function(){var n={},i;n[t.Constants.ActorProperties.PlayerName]=this.name;for(i in this.customProperties)n[i]=this.customProperties[i];return n},n.prototype._setLBC=function(n){this.loadBalancingClient=n},n.prototype._updateFromResponse=function(n){var i,r;this.actorNr=n[t.Constants.ParameterCode.ActorNr];i=n[t.Constants.ParameterCode.PlayerProperties];i!==undefined&&(r=i[t.Constants.ActorProperties.PlayerName],r!==undefined&&(this.name=r),this._updateCustomProperties(i))},n.prototype._updateMyActorFromResponse=function(n){this.actorNr=n[t.Constants.ParameterCode.ActorNr];this.joinToken=this.actorNr?this.actorNr.toString():null},n.prototype._updateCustomProperties=function(n){for(var t in n)this.customProperties[t]=n[t];this.onPropertiesChange(n,!1)},n.prototype._setSuspended=function(n){this.suspended=n},n._getActorNrFromResponse=function(n){return n[t.Constants.ParameterCode.ActorNr]},n}(),u,o,l,f,s,h,c;t.Actor=r;u=function(){function n(n){this.name="";this.address="";this.maxPlayers=0;this.isVisible=!0;this.isOpen=!0;this.playerCount=0;this.emptyRoomLiveTime=0;this.suspendedPlayerLiveTime=0;this.uniqueUserId=!1;this.removed=!1;this.cleanupCacheOnLeave=!1;this.masterClientId=0;this._customProperties={};this._propsListedInLobby=[];this.name=n}return n.prototype.onPropertiesChange=function(){},n.prototype.getCustomProperty=function(n){return this._customProperties[n]},n.prototype.getCustomPropertyOrElse=function(n,t){return Exitgames.Common.Util.getPropertyOrElse(this._customProperties,n,t)},n.prototype._updateFromMasterResponse=function(n){this.address=n[t.Constants.ParameterCode.Address];var i=n[t.Constants.ParameterCode.RoomName];i&&(this.name=i)},n.prototype._updateFromProps=function(n){var r,i;if(n){this.maxPlayers=this.updateIfExists(this.maxPlayers,t.Constants.GameProperties.MaxPlayers,n);this.isVisible=this.updateIfExists(this.isVisible,t.Constants.GameProperties.IsVisible,n);this.isOpen=this.updateIfExists(this.isOpen,t.Constants.GameProperties.IsOpen,n);this.playerCount=this.updateIfExists(this.playerCount,t.Constants.GameProperties.PlayerCount,n);this.removed=this.updateIfExists(this.removed,t.Constants.GameProperties.Removed,n);this._propsListedInLobby=this.updateIfExists(this._propsListedInLobby,t.Constants.GameProperties.PropsListedInLobby,n);this.cleanupCacheOnLeave=this.updateIfExists(this.cleanupCacheOnLeave,t.Constants.GameProperties.CleanupCacheOnLeave,n);this.masterClientId=this.updateIfExists(this.masterClientId,t.Constants.GameProperties.MasterClientId,n);r={};for(i in n)parseInt(i).toString()!=i&&this._customProperties[i]!==n[i]&&(this._customProperties[i]=n[i],r[i]=n[i]);this.onPropertiesChange(r,!1)}},n.prototype._updateFromEvent=function(n){n&&(this.masterClientId=this.updateIfExists(this.masterClientId,t.Constants.ParameterCode.MasterClientId,n))},n.prototype.updateIfExists=function(n,t,i){return i.hasOwnProperty(t)?i[t]:n},n}();t.RoomInfo=u;o=function(n){function i(t){return n.call(this,t)||this}return __extends(i,n),i.prototype.setCustomProperty=function(n,t,i,r){var u,e,f;i===void 0&&(i=!1);this._customProperties[n]=t;u={};u[n]=t;r!=undefined&&(e=(f={},f[n]=r,f));this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfRoom(u,i,e);this.onPropertiesChange(u,!0)},i.prototype.setCustomProperties=function(n,t,i){var u,r;t===void 0&&(t=!1);u={};for(r in n)this._customProperties[r]=n[r],u[r]=n[r];this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfRoom(u,t,i);this.onPropertiesChange(u,!0)},i.prototype.setProp=function(n,t){if(this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()){var i={};i[n]=t;this.loadBalancingClient._setPropertiesOfRoom(i,!1,undefined)}},i.prototype.setIsVisible=function(n){this.isVisible!=n&&(this.isVisible=n,this.setProp(t.Constants.GameProperties.IsVisible,n))},i.prototype.setIsOpen=function(n){this.isOpen!=n&&(this.isOpen=n,this.setProp(t.Constants.GameProperties.IsOpen,n))},i.prototype.setMaxPlayers=function(n){this.maxPlayers!=n&&(this.maxPlayers=n,this.setProp(t.Constants.GameProperties.MaxPlayers,n))},i.prototype.setEmptyRoomLiveTime=function(n){this.emptyRoomLiveTime=n},i.prototype.setSuspendedPlayerLiveTime=function(n){this.suspendedPlayerLiveTime=n},i.prototype.setPlugins=function(n){this.plugins=n},i.prototype.setUniqueUserId=function(n){this.uniqueUserId=n},i.prototype.setPropsListedInLobby=function(n){this._propsListedInLobby=n},i.prototype._setLBC=function(n){this.loadBalancingClient=n},i}(u);t.Room=o;l=function(){function i(r,u,f){var h,e,o,s;if(this.appId=u,this.appVersion=f,this.autoJoinLobby=!0,this.connectOptions={},this.createRoomOptions={},this.joinRoomOptions={},this.roomInfos=[],this.roomInfosDict={},this.actors={},this.actorsArray=[],this.lowestActorId=0,this.userAuthType=t.Constants.CustomAuthenticationType.None,this.userAuthParameters="",this.userAuthData="",this.lobbyStatsRequestList=[],this.state=i.State.Uninitialized,this.logger=new Exitgames.Common.Logger("Client:"),this.validNextState={},h="",typeof r=="number"){this.connectionProtocol=r;switch(r){case n.ConnectionProtocol.Ws:this.masterServerAddress="ws://app-eu.exitgamescloud.com:9090";this.nameServerAddress="ws://ns.exitgames.com:9093";break;case n.ConnectionProtocol.Wss:this.masterServerAddress="wss://app-eu.exitgamescloud.com:19090";this.nameServerAddress="wss://ns.exitgames.com:19093";break;default:e="wrong_protocol_error";this.masterServerAddress=e;this.nameServerAddress=e;this.logger.error("Wrong protocol: ",r)}}else typeof r=="string"?(this.connectionProtocol=n.ConnectionProtocol.Ws,o=r,this.masterServerAddress=o,this.nameServerAddress=o):(this.connectionProtocol=n.ConnectionProtocol.Ws,s="wrong_protocol_type_error",this.masterServerAddress=s,this.nameServerAddress=s,this.logger.error("Wrong protocol type: ",typeof r));this.initValidNextState();this.currentRoom=this.roomFactoryInternal("");this._myActor=this.actorFactoryInternal("",-1,!0);this.addActor(this._myActor)}return i.prototype.onStateChange=function(){},i.prototype.onError=function(){},i.prototype.onOperationResponse=function(){},i.prototype.onEvent=function(){},i.prototype.onRoomList=function(){},i.prototype.onRoomListUpdate=function(){},i.prototype.onMyRoomPropertiesChange=function(){},i.prototype.onActorPropertiesChange=function(){},i.prototype.onJoinRoom=function(){},i.prototype.onActorJoin=function(){},i.prototype.onActorLeave=function(){},i.prototype.onActorSuspend=function(){},i.prototype.onFindFriendsResult=function(){},i.prototype.onLobbyStats=function(){},i.prototype.onAppStats=function(){},i.prototype.onGetRegionsResult=function(){},i.prototype.onWebRpcResult=function(){},i.prototype.roomFactory=function(n){return new o(n)},i.prototype.actorFactory=function(n,t,i){return new r(n,t,i)},i.prototype.myActor=function(){return this._myActor},i.prototype.myRoom=function(){return this.currentRoom},i.prototype.myRoomActors=function(){return this.actors},i.prototype.myRoomActorCount=function(){return this.actorsArray.length},i.prototype.myRoomActorsArray=function(){return this.actorsArray},i.prototype.myRoomMasterActorNr=function(){return this.myRoom().masterClientId?this.myRoom().masterClientId:this.lowestActorId},i.prototype.lastRtt=function(){return this.gamePeer&&this.gamePeer.getLastRtt()},i.prototype.roomFactoryInternal=function(n){n===void 0&&(n="");var t=this.roomFactory(n);return t._setLBC(this),t},i.prototype.actorFactoryInternal=function(n,t,i){n===void 0&&(n="");t===void 0&&(t=-1);i===void 0&&(i=!1);var r=this.actorFactory(n,t,i);return r._setLBC(this),r},i.prototype.setNameServerAddress=function(n){this.nameServerAddress=n},i.prototype.getNameServerAddress=function(){return this.nameServerAddress},i.prototype.setMasterServerAddress=function(n){this.masterServerAddress=n},i.prototype.getMasterServerAddress=function(){return this.nameServerAddress},i.prototype.setUserId=function(n){this.userId=n},i.prototype.getUserId=function(){return this.userId},i.prototype.setCustomAuthentication=function(t,i,r){i===void 0&&(i=n.LoadBalancing.Constants.CustomAuthenticationType.Custom);this.userAuthType=i;this.userAuthParameters=t;this.userAuthData=r},i.prototype.connect=function(n){if(typeof n=="boolean"&&(n=n?{keepMasterConnection:!0}:{keepMasterConnection:!1}),n||(n={}),this.checkNextState(i.State.ConnectingToMasterserver,!0)){this.changeState(i.State.ConnectingToMasterserver);this.logger.info("Connecting to Master",this.masterServerAddress);this.connectOptions={};for(var t in n)this.connectOptions[t]=n[t];return this.masterPeer=new h(this,e(this.masterServerAddress,this.connectionProtocol),""),this.initMasterPeer(this.masterPeer),this.masterPeer.connect(this.appId),!0}return!1},i.prototype.connectToNameServer=function(n){if(n||(n={}),this.checkNextState(i.State.ConnectingToNameServer,!0)){this.changeState(i.State.ConnectingToNameServer);this.logger.info("Connecting to NameServer",this.nameServerAddress);this.connectOptions={};for(var t in n)this.connectOptions[t]=n[t];return this.nameServerPeer=new s(this,e(this.nameServerAddress,this.connectionProtocol),""),this.initNameServerPeer(this.nameServerPeer),this.nameServerPeer.connect(this.appId),!0}return!1},i.prototype.fillCreateRoomOptions=function(i,r){var u,f;if(r=r||{},u={},r.isVisible!==undefined&&(u[t.Constants.GameProperties.IsVisible]=r.isVisible),r.isOpen!==undefined&&(u[t.Constants.GameProperties.IsOpen]=r.isOpen),r.maxPlayers!==undefined&&(u[t.Constants.GameProperties.MaxPlayers]=r.maxPlayers),r.propsListedInLobby!==undefined&&(u[t.Constants.GameProperties.PropsListedInLobby]=n.TypeExt.String(r.propsListedInLobby)),r.customGameProperties!==undefined)for(f in r.customGameProperties)u[f]=r.customGameProperties[f];i.push(t.Constants.ParameterCode.GameProperties,u);i.push(t.Constants.ParameterCode.CleanupCacheOnLeave,!0);i.push(t.Constants.ParameterCode.Broadcast,!0);r.emptyRoomLiveTime!==undefined&&i.push(t.Constants.ParameterCode.EmptyRoomTTL,n.TypeExt.Int(r.emptyRoomLiveTime));r.suspendedPlayerLiveTime!==undefined&&i.push(t.Constants.ParameterCode.PlayerTTL,n.TypeExt.Int(r.suspendedPlayerLiveTime));r.plugins!==undefined&&i.push(t.Constants.ParameterCode.Plugins,r.plugins);r.uniqueUserId!==undefined&&i.push(t.Constants.ParameterCode.CheckUserOnJoin,r.uniqueUserId);r.lobbyName&&(i.push(t.Constants.ParameterCode.LobbyName),i.push(r.lobbyName),r.lobbyType!=undefined&&(i.push(t.Constants.ParameterCode.LobbyType),i.push(r.lobbyType)))},i.prototype.createRoomFromMy=function(n,t){return this.currentRoom.name=n?n:"",t=this.copyCreateOptionsFromMyRoom(t),this.createRoomInternal(this.masterPeer,t)},i.prototype.copyCreateOptionsFromMyRoom=function(n){return n=n||{},n.isVisible=this.currentRoom.isVisible,n.isOpen=this.currentRoom.isOpen,n.maxPlayers=this.currentRoom.maxPlayers,n.customGameProperties=this.currentRoom._customProperties,n.propsListedInLobby=this.currentRoom._propsListedInLobby,n.emptyRoomLiveTime=this.currentRoom.emptyRoomLiveTime,n.suspendedPlayerLiveTime=this.currentRoom.suspendedPlayerLiveTime,n.plugins=this.currentRoom.plugins,n.uniqueUserId=this.currentRoom.uniqueUserId,n},i.prototype.createRoom=function(n,t){return this.currentRoom=this.roomFactoryInternal(n?n:""),this.createRoomInternal(this.masterPeer,t)},i.prototype.joinRoom=function(n,r,u){var f=[];return r&&(r.createIfNotExists&&(f.push(t.Constants.ParameterCode.JoinMode,i.JoinMode.CreateIfNotExists),this.fillCreateRoomOptions(f,u)),r.joinToken&&(f.push(t.Constants.ParameterCode.ActorNr,parseInt(r.joinToken)),f.push(t.Constants.ParameterCode.JoinMode,i.JoinMode.Rejoin))),this.currentRoom=this.roomFactoryInternal(n),f.push(t.Constants.ParameterCode.RoomName,n),this.joinRoomOptions=r||{},this.createRoomOptions=u||{},this.logger.info("Join Room",n,r,u,"..."),this.masterPeer.sendOperation(t.Constants.OperationCode.JoinGame,f),!0},i.prototype.joinRandomRoom=function(n){var i=[],r,u,f;if(n){if(n.matchingType!=undefined&&n.matchingType!=t.Constants.MatchmakingMode.FillRoom&&(i.push(t.Constants.ParameterCode.MatchMakingType),i.push(n.matchingType)),r={},u=!1,n.expectedCustomRoomProperties!=undefined)for(f in n.expectedCustomRoomProperties)r[f]=n.expectedCustomRoomProperties[f],u=!0;n.expectedMaxPlayers!=undefined&&n.expectedMaxPlayers>0&&(r[t.Constants.GameProperties.MaxPlayers]=n.expectedMaxPlayers,u=!0);u&&(i.push(t.Constants.ParameterCode.GameProperties),i.push(r));n.lobbyName&&(i.push(t.Constants.ParameterCode.LobbyName),i.push(n.lobbyName),n.lobbyType!=undefined&&(i.push(t.Constants.ParameterCode.LobbyType),i.push(n.lobbyType)));n.sqlLobbyFilter&&(i.push(t.Constants.ParameterCode.Data),i.push(n.sqlLobbyFilter))}return this.logger.info("Join Random Room",n&&n.lobbyName,n&&n.lobbyType,"..."),this.masterPeer.sendOperation(t.Constants.OperationCode.JoinRandomGame,i),!0},i.prototype._setPropertiesOfRoom=function(n,i,r){var u=[];u.push(t.Constants.ParameterCode.Properties);u.push(n);u.push(t.Constants.ParameterCode.Broadcast);u.push(!0);i&&(u.push(t.Constants.ParameterCode.Forward),u.push(!0));r&&(u.push(t.Constants.ParameterCode.ExpectedValues),u.push(r));this.gamePeer.sendOperation(t.Constants.OperationCode.SetProperties,u)},i.prototype._setPropertiesOfActor=function(n,i,r,u){var f=[];f.push(t.Constants.ParameterCode.ActorNr);f.push(n);f.push(t.Constants.ParameterCode.Properties);f.push(i);f.push(t.Constants.ParameterCode.Broadcast);f.push(!0);r&&(f.push(t.Constants.ParameterCode.Forward),f.push(!0));u&&(f.push(t.Constants.ParameterCode.ExpectedValues),f.push(u));this.gamePeer.sendOperation(t.Constants.OperationCode.SetProperties,f)},i.prototype.disconnect=function(){this.nameServerPeer&&this.nameServerPeer.disconnect();this._cleanupNameServerPeerData();this.masterPeer&&this.masterPeer.disconnect();this._cleanupMasterPeerData();this.gamePeer&&this.gamePeer.disconnect();this._cleanupGamePeerData();this.changeState(i.State.Disconnected)},i.prototype.suspendRoom=function(){this.isJoinedToRoom()&&(this.gamePeer&&this.gamePeer.disconnect(),this._cleanupGamePeerData(),this.isConnectedToMaster()?this.changeState(i.State.JoinedLobby):(this.changeState(i.State.Disconnected),this.connect(this.connectOptions)))},i.prototype.leaveRoom=function(){this.isJoinedToRoom()&&(this.gamePeer&&(this.gamePeer.sendOperation(t.Constants.OperationCode.Leave),this.gamePeerWaitingForDisconnect=!0),this._cleanupGamePeerData(),this.isConnectedToMaster()?this.changeState(i.State.JoinedLobby):(this.changeState(i.State.Disconnected),this.connect(this.connectOptions)))},i.prototype.raiseEvent=function(n,t,i){this.isJoinedToRoom()&&this.gamePeer.raiseEvent(n,t,i)},i.prototype.changeGroups=function(n,t){this.isJoinedToRoom()&&(this.logger.debug("Group change:",n,t),this.gamePeer.changeGroups(n,t))},i.prototype.findFriends=function(n){if(this.isConnectedToMaster())if(n&&typeof n=="object"){this.findFriendsRequestList=[];for(var t=0;t<n.length;++t)if(typeof n[t]=="string")this.findFriendsRequestList[t]=n[t];else{this.logger.error("FindFriends request error:","Friend name is not a string",t);this.onFindFriendsResult(-1,"Friend name is not a string "+t,{});return}this.logger.debug("Find friends:",n);this.masterPeer.findFriends(this.findFriendsRequestList)}else{this.logger.error("FindFriends request error:","Parameter is not an array");this.onFindFriendsResult(-1,"Parameter is not an array",{})}else{this.logger.error("FindFriends request error:","Not connected to Master");this.onFindFriendsResult(i.PeerErrorCode.MasterError,"Not connected to Master",{})}},i.prototype.requestLobbyStats=function(n){var r,u,f,e;if(this.isConnectedToMaster()){if(this.lobbyStatsRequestList=[],n)if(typeof n=="object")for(r=0;r<n.length;++r)if(u=n[r],typeof u=="object")if(f=u[0],f){if(u[1]===undefined)e=t.Constants.LobbyType.Default;else if(typeof u[1]=="number")e=u[1];else{this.requestLobbyStatsErr("Lobby type is invalid",r);return}this.lobbyStatsRequestList[r]=[f.toString(),e]}else{this.requestLobbyStatsErr("Lobby name is empty",r);return}else{this.requestLobbyStatsErr("Lobby id is not an array",r);return}else{this.requestLobbyStatsErr("Parameter is not an array");return}this.masterPeer.requestLobbyStats(this.lobbyStatsRequestList)}else{this.logger.error("LobbyState request error:","Not connected to Master");this.onLobbyStats(i.PeerErrorCode.MasterError,"Not connected to Master",[])}},i.prototype.requestLobbyStatsErr=function(n,t){t===void 0&&(t="");this.logger.error("LobbyState request error:",n,t);this.onLobbyStats(-1,n+" "+t,[])},i.prototype.getRegions=function(){if(this.isConnectedToNameServer())this.logger.debug("GetRegions..."),this.nameServerPeer.getRegions(this.appId);else{this.logger.error("GetRegions request error:","Not connected to NameServer");this.onGetRegionsResult(i.PeerErrorCode.NameServerError,"Not connected to NameServer",{})}},i.prototype.webRpc=function(n,t){if(this.isConnectedToMaster())this.logger.debug("WebRpc..."),this.masterPeer.webRpc(n,t);else if(this.isJoinedToRoom())this.logger.debug("WebRpc..."),this.gamePeer.webRpc(n,t);else{this.logger.error("WebRpc request error:","Connected to neither Master nor Game server");this.onWebRpcResult(i.PeerErrorCode.MasterError,"Connected to neither Master nor Game server",n,0,{})}},i.prototype.connectToRegionMaster=function(n){return this.isConnectedToNameServer()?(this.logger.debug("Connecting to Region Master",n,"..."),this.nameServerPeer.opAuth(this.appId,this.appVersion,this.userAuthType,this.userAuthParameters,this.userAuthData,this.userId,n),!0):this.connectToNameServer({region:n})?!0:(this.logger.error("Connecting to Region Master error:","Not connected to NameServer"),!1)},i.prototype.isConnectedToMaster=function(){return this.masterPeer&&this.masterPeer.isConnected()},i.prototype.isConnectedToNameServer=function(){return this.nameServerPeer&&this.nameServerPeer.isConnected()},i.prototype.isInLobby=function(){return this.state==i.State.JoinedLobby},i.prototype.isJoinedToRoom=function(){return this.state==i.State.Joined},i.prototype.isConnectedToGame=function(){return this.isJoinedToRoom()},i.prototype.availableRooms=function(){return this.roomInfos},i.prototype.setLogLevel=function(n){this.logger.setLevel(n);this.nameServerPeer&&this.nameServerPeer.setLogLevel(n);this.masterPeer&&this.masterPeer.setLogLevel(n);this.gamePeer&&this.gamePeer.setLogLevel(n)},i.prototype.addRoom=function(n){this.roomInfos.push(n);this.roomInfosDict[n.name]=n},i.prototype.clearRooms=function(){this.roomInfos=[];this.roomInfosDict={}},i.prototype.purgeRemovedRooms=function(){this.roomInfos=this.roomInfos.filter(function(n){return!n.removed});for(var n in this.roomInfosDict)this.roomInfosDict[n].removed&&delete this.roomInfosDict[n]},i.prototype.addActor=function(n){this.actors[n.actorNr]=n;this.actorsArray.push(n);this.currentRoom.playerCount=this.actorsArray.length;(this.lowestActorId==0||this.lowestActorId>n.actorNr)&&(this.lowestActorId=n.actorNr)},i.prototype.removeActor=function(n){delete this.actors[n];this.actorsArray=this.actorsArray.filter(function(t){return t.actorNr!=n});this.currentRoom.playerCount=this.actorsArray.length;this.lowestActorId==n&&(this.lowestActorId=this.actorsArray.length>0?this.actorsArray.reduce(function(n,t){return n.actorNr<t.actorNr?n:t}).actorNr:0)},i.prototype.clearActors=function(){this.actors={};this.actorsArray=[];this.currentRoom.playerCount=0;this.lowestActorId=0},i.prototype.changeState=function(n){this.logger.info("State:",i.StateToName(this.state),"->",i.StateToName(n));this.state=n;this.onStateChange(n)},i.prototype.createRoomInternal=function(n,i){var r=[],u;this.currentRoom.name&&r.push(t.Constants.ParameterCode.RoomName,this.currentRoom.name);this.fillCreateRoomOptions(r,i);n===this.masterPeer&&(this.createRoomOptions=i);n===this.gamePeer&&(r.push(t.Constants.ParameterCode.PlayerProperties),r.push(this._myActor._getAllProperties()));u=n==this.gamePeer?this.gamePeer._logger:this.masterPeer._logger;u.info("Create Room",i&&i.lobbyName,i&&i.lobbyType,"...");n.sendOperation(t.Constants.OperationCode.CreateGame,r)},i.prototype.updateUserIdAndNickname=function(n,i){var u=n[t.Constants.ParameterCode.UserId],r;u!=undefined&&(this.setUserId(u),i.info("Setting userId sent by server:",u));r=n[t.Constants.ParameterCode.Nickname];r!=undefined&&(this.myActor().setName(r),i.info("Setting nickname sent by server:",r))},i.prototype.initNameServerPeer=function(r){var u=this;r.setLogLevel(this.logger.getLevel());r.addPeerStatusListener(n.PhotonPeer.StatusCodes.error,function(){u.changeState(i.State.Error);u._onErrorInternal(i.PeerErrorCode.NameServerError,"NameServer peer error")});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connectFailed,function(){u.changeState(i.State.Error);u._onErrorInternal(i.PeerErrorCode.NameServerConnectFailed,"NameServer peer connect failed. "+u.nameServerAddress)});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.timeout,function(){u.changeState(i.State.Error);u._onErrorInternal(i.PeerErrorCode.NameServerTimeout,"NameServer peer timeout")});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connecting,function(){});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connect,function(){r._logger.info("Connected");u.changeState(i.State.ConnectedToNameServer);u.connectOptions.region!=undefined&&r.opAuth(u.appId,u.appVersion,u.userAuthType,u.userAuthParameters,u.userAuthData,u.userId,u.connectOptions.region)});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.disconnect,function(){r==u.nameServerPeer&&(u._cleanupNameServerPeerData(),r._logger.info("Disconnected"))});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connectClosed,function(){r._logger.info("Server closed connection");u.changeState(i.State.Error);u._onErrorInternal(i.PeerErrorCode.NameServerConnectClosed,"NameServer server closed connection")});r.addResponseListener(t.Constants.OperationCode.GetRegions,function(n){var i,f,o,e;if(r._logger.debug("resp GetRegions",n),i={},n.errCode==0){f=n.vals[t.Constants.ParameterCode.Region];o=n.vals[t.Constants.ParameterCode.Address];for(e in f)i[f[e]]=o[e]}else r._logger.error("GetRegions request error.",n.errCode);u.onGetRegionsResult(n.errCode,n.errMsg,i)});r.addResponseListener(t.Constants.OperationCode.Authenticate,function(n){r._logger.debug("resp Authenticate",n);n.errCode==0?(r._logger.info("Authenticated"),r.disconnect(),u.updateUserIdAndNickname(n.vals,r._logger),u.masterServerAddress=n.vals[t.Constants.ParameterCode.Address],r._logger.info("Connecting to Master server",u.masterServerAddress,"..."),u.connect({userAuthSecret:n.vals[t.Constants.ParameterCode.Secret]})):(u.changeState(i.State.Error),u._onErrorInternal(i.PeerErrorCode.NameServerAuthenticationFailed,"NameServer authentication failed: "+n.errCode+" "+n.errMsg))})},i.prototype.initMasterPeer=function(r){var f=this;r.setLogLevel(this.logger.getLevel());r.addPeerStatusListener(n.PhotonPeer.StatusCodes.error,function(){f.changeState(i.State.Error);f._onErrorInternal(i.PeerErrorCode.MasterError,"Master peer error")});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connectFailed,function(){f.changeState(i.State.Error);f._onErrorInternal(i.PeerErrorCode.MasterConnectFailed,"Master peer connect failed: "+f.masterServerAddress)});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.timeout,function(){f.changeState(i.State.Error);f._onErrorInternal(i.PeerErrorCode.MasterTimeout,"Master peer error timeout")});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connecting,function(){});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connect,function(){r._logger.info("Connected");var i=[];f.connectOptions.userAuthSecret?(i.push(t.Constants.ParameterCode.Secret,f.connectOptions.userAuthSecret),r.sendOperation(t.Constants.OperationCode.Authenticate,i),r._logger.info("Authenticate with secret...")):(i.push(t.Constants.ParameterCode.ApplicationId),i.push(f.appId),i.push(t.Constants.ParameterCode.AppVersion),i.push(f.appVersion),f.userAuthType!=t.Constants.CustomAuthenticationType.None&&(i.push(t.Constants.ParameterCode.ClientAuthenticationType,n.TypeExt.Byte(f.userAuthType)),i.push(t.Constants.ParameterCode.ClientAuthenticationParams,f.userAuthParameters),f.userAuthData&&i.push(t.Constants.ParameterCode.ClientAuthenticationData,f.userAuthData)),f.userId&&i.push(t.Constants.ParameterCode.UserId,f.userId),f.connectOptions.lobbyStats&&i.push(t.Constants.ParameterCode.LobbyStats,!0),r.sendOperation(t.Constants.OperationCode.Authenticate,i),r._logger.info("Authenticate..."))});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.disconnect,function(){r==f.masterPeer&&(f._cleanupMasterPeerData(),r._logger.info("Disconnected"))});r.addPeerStatusListener(n.PhotonPeer.StatusCodes.connectClosed,function(){r._logger.info("Server closed connection");f.changeState(i.State.Error);f._onErrorInternal(i.PeerErrorCode.MasterConnectClosed,"Master server closed connection")});r.addEventListener(t.Constants.EventCode.GameList,function(n){var i=n.vals[t.Constants.ParameterCode.GameList],e,o;f.clearRooms();for(e in i)o=new u(e),o._updateFromProps(i[e]),f.addRoom(o);f.onRoomList(f.roomInfos);r._logger.debug("ev GameList",f.roomInfos,i)});r.addEventListener(t.Constants.EventCode.GameListUpdate,function(n){var o=n.vals[t.Constants.ParameterCode.GameList],h=[],c=[],l=[],i,a,e,s;for(i in o)a=f.roomInfos.filter(function(n){return n.name==i}),a.length>0?(e=a[0],e._updateFromProps(o[i]),e.removed?l.push(e):h.push(e)):(s=new u(i),s._updateFromProps(o[i]),f.addRoom(s),c.push(s));f.purgeRemovedRooms();f.onRoomListUpdate(f.roomInfos,h,c,l);r._logger.debug("ev GameListUpdate:",f.roomInfos,"u:",h,"a:",c,"r:",l,o)});r.addResponseListener(t.Constants.OperationCode.Authenticate,function(n){if(r._logger.debug("resp Authenticate",n),n.errCode)f.changeState(i.State.Error),f._onErrorInternal(i.PeerErrorCode.MasterAuthenticationFailed,"Master authentication failed: "+n.errCode+" "+n.errMsg);else{r._logger.info("Authenticated");f.updateUserIdAndNickname(n.vals,r._logger);n.vals[t.Constants.ParameterCode.Secret]!=undefined&&(f.connectOptions.userAuthSecret=n.vals[t.Constants.ParameterCode.Secret]);f.changeState(i.State.ConnectedToMaster);var u=[];f.connectOptions.lobbyName&&(u.push(t.Constants.ParameterCode.LobbyName),u.push(f.connectOptions.lobbyName),f.connectOptions.lobbyType!=undefined&&(u.push(t.Constants.ParameterCode.LobbyType),u.push(f.connectOptions.lobbyType)));f.autoJoinLobby&&(r.sendOperation(t.Constants.OperationCode.JoinLobby,u),r._logger.info("Join Lobby",f.connectOptions.lobbyName,f.connectOptions.lobbyType,"..."))}});r.addResponseListener(t.Constants.OperationCode.JoinLobby,function(n){r._logger.debug("resp JoinLobby",n);n.errCode||(r._logger.info("Joined to Lobby"),f.changeState(i.State.JoinedLobby));f._onOperationResponseInternal2(t.Constants.OperationCode.JoinLobby,n)});r.addResponseListener(t.Constants.OperationCode.CreateGame,function(n){r._logger.debug("resp CreateGame",n);n.errCode||(f.currentRoom._updateFromMasterResponse(n.vals),r._logger.debug("Created/Joined "+f.currentRoom.name),f.connectToGameServer(t.Constants.OperationCode.CreateGame));f._onOperationResponseInternal2(t.Constants.OperationCode.CreateGame,n)});r.addResponseListener(t.Constants.OperationCode.JoinGame,function(n){r._logger.debug("resp JoinGame",n);n.errCode||(f.currentRoom._updateFromMasterResponse(n.vals),r._logger.debug("Joined "+f.currentRoom.name),f.connectToGameServer(t.Constants.OperationCode.JoinGame));f._onOperationResponseInternal2(t.Constants.OperationCode.JoinGame,n)});r.addResponseListener(t.Constants.OperationCode.JoinRandomGame,function(n){r._logger.debug("resp JoinRandomGame",n);n.errCode||(f.currentRoom._updateFromMasterResponse(n.vals),r._logger.debug("Joined "+f.currentRoom.name),f.connectToGameServer(t.Constants.OperationCode.JoinRandomGame));f._onOperationResponseInternal2(t.Constants.OperationCode.JoinRandomGame,n)});r.addResponseListener(t.Constants.OperationCode.FindFriends,function(n){var u,o,s,i,e;if(r._logger.debug("resp FindFriends",n),u={},n.errCode)r._logger.error("FindFriends request error:",n.errCode);else for(o=n.vals[t.Constants.ParameterCode.FindFriendsResponseOnlineList]||{},s=n.vals[t.Constants.ParameterCode.FindFriendsResponseRoomIdList]||{},i=0;i<f.findFriendsRequestList.length;++i)e=f.findFriendsRequestList[i],e&&(u[e]={online:o[i],roomId:s[i]});f.onFindFriendsResult(n.errCode,n.errMsg,u)});r.addResponseListener(t.Constants.OperationCode.LobbyStats,function(n){var u,i,o;if(r._logger.debug("resp LobbyStats",n),u=[],n.errCode)r._logger.error("LobbyStats request error:",n.errCode);else{var e=n.vals[t.Constants.ParameterCode.LobbyName],c=n.vals[t.Constants.ParameterCode.LobbyType]||{},s=n.vals[t.Constants.ParameterCode.PeerCount]||{},h=n.vals[t.Constants.ParameterCode.GameCount]||{};if(e)for(i=0;i<e.length;++i)u[i]={lobbyName:e[i],lobbyType:c[i],peerCount:s[i],gameCount:h[i]};else for(i=0;i<f.lobbyStatsRequestList.length;++i)o=f.lobbyStatsRequestList[i],u[i]={lobbyName:o[0],lobbyType:o[1],peerCount:s[i],gameCount:h[i]}}f.onLobbyStats(n.errCode,n.errMsg,u)});r.addEventListener(t.Constants.EventCode.LobbyStats,function(n){var i;r._logger.debug("ev LobbyStats",n);var e=[],u=n.vals[t.Constants.ParameterCode.LobbyName],o=n.vals[t.Constants.ParameterCode.LobbyType]||{},s=n.vals[t.Constants.ParameterCode.PeerCount]||{},h=n.vals[t.Constants.ParameterCode.GameCount]||{};if(u)for(i=0;i<u.length;++i)e[i]={lobbyName:u[i],lobbyType:o[i],peerCount:s[i],gameCount:h[i]};f.onLobbyStats(0,"",e)});r.addEventListener(t.Constants.EventCode.AppStats,function(n){r._logger.debug("ev AppStats",n);var i={peerCount:n.vals[t.Constants.ParameterCode.PeerCount],masterPeerCount:n.vals[t.Constants.ParameterCode.MasterPeerCount],gameCount:n.vals[t.Constants.ParameterCode.GameCount]};f.onAppStats(0,"",i)});r.addResponseListener(t.Constants.OperationCode.Rpc,r.webRpcHandler(this))},i.prototype.connectToGameServer=function(n){return this.connectOptions.keepMasterConnection||this.masterPeer.disconnect(),this.checkNextState(i.State.ConnectingToGameserver,!0)?(this.logger.info("Connecting to Game",this.currentRoom.address),this.gamePeer=new c(this,e(this.currentRoom.address,this.connectionProtocol),""),this.gamePeerWaitingForDisconnect=!1,this.initGamePeer(this.gamePeer,n),this.gamePeer.connect(this.appId),this.changeState(i.State.ConnectingToGameserver),!0):!1},i.prototype.initGamePeer=function(u,f){var e=this;u.setLogLevel(this.logger.getLevel());u.addPeerStatusListener(n.PhotonPeer.StatusCodes.error,function(){e.changeState(i.State.Error);e._onErrorInternal(i.PeerErrorCode.GameError,"Game peer error")});u.addPeerStatusListener(n.PhotonPeer.StatusCodes.connectFailed,function(){e.changeState(i.State.Error);e._onErrorInternal(i.PeerErrorCode.GameConnectFailed,"Game peer connect failed: "+e.currentRoom.address)});u.addPeerStatusListener(n.PhotonPeer.StatusCodes.timeout,function(){e.changeState(i.State.Error);e._onErrorInternal(i.PeerErrorCode.GameTimeout,"Game peer timeout")});u.addPeerStatusListener(n.PhotonPeer.StatusCodes.connect,function(){u._logger.info("Connected");var i=[];i.push(t.Constants.ParameterCode.ApplicationId);i.push(e.appId);i.push(t.Constants.ParameterCode.AppVersion);i.push(e.appVersion);e.connectOptions.userAuthSecret!=undefined&&(i.push(t.Constants.ParameterCode.Secret),i.push(e.connectOptions.userAuthSecret));e.userAuthType!=t.Constants.CustomAuthenticationType.None&&(i.push(t.Constants.ParameterCode.ClientAuthenticationType),i.push(n.TypeExt.Byte(e.userAuthType)));e.userId&&i.push(t.Constants.ParameterCode.UserId,e.userId);u.sendOperation(t.Constants.OperationCode.Authenticate,i);u._logger.info("Authenticate...")});u.addPeerStatusListener(n.PhotonPeer.StatusCodes.disconnect,function(){u==e.gamePeer&&(e._cleanupGamePeerData(),u._logger.info("Disconnected"))});u.addPeerStatusListener(n.PhotonPeer.StatusCodes.connectClosed,function(){u._logger.info("Server closed connection");e.gamePeerWaitingForDisconnect||(e.changeState(i.State.Error),e._onErrorInternal(i.PeerErrorCode.MasterConnectClosed,"Game server closed connection"))});u.addResponseListener(t.Constants.OperationCode.Authenticate,function(n){if(u._logger.debug("resp Authenticate",n),n.errCode)e.changeState(i.State.Error),e._onErrorInternal(i.PeerErrorCode.GameAuthenticationFailed,"Game authentication failed: "+n.errCode+" "+n.errMsg);else{if(u._logger.info("Authenticated"),u._logger.info("Connected"),f==t.Constants.OperationCode.CreateGame)e.createRoomInternal(u,e.createRoomOptions);else{var r=[];r.push(t.Constants.ParameterCode.RoomName);r.push(e.currentRoom.name);r.push(t.Constants.ParameterCode.Broadcast);r.push(!0);r.push(t.Constants.ParameterCode.PlayerProperties);r.push(e._myActor._getAllProperties());f==t.Constants.OperationCode.JoinGame&&(e.joinRoomOptions.createIfNotExists&&(r.push(t.Constants.ParameterCode.JoinMode,i.JoinMode.CreateIfNotExists),e.fillCreateRoomOptions(r,e.createRoomOptions)),e.joinRoomOptions.joinToken&&(r.push(t.Constants.ParameterCode.ActorNr,parseInt(e.joinRoomOptions.joinToken)),r.push(t.Constants.ParameterCode.JoinMode,i.JoinMode.Rejoin)));u.sendOperation(t.Constants.OperationCode.JoinGame,r)}e.changeState(i.State.ConnectedToGameserver)}});u.addResponseListener(t.Constants.OperationCode.CreateGame,function(n){if(u._logger.debug("resp CreateGame",n),!n.errCode){e._myActor._updateMyActorFromResponse(n.vals);u._logger.info("myActor: ",e._myActor);e.currentRoom._updateFromProps(n.vals[t.Constants.ParameterCode.GameProperties]);e.clearActors();e.addActor(e._myActor);e.changeState(i.State.Joined);e.onJoinRoom(!0)}e._onOperationResponseInternal2(t.Constants.OperationCode.CreateGame,n)});u.addResponseListener(t.Constants.OperationCode.JoinGame,function(n){var f,h,c,o,r,l,s;if(u._logger.debug("resp JoinGame",n),!n.errCode){if(e._myActor._updateMyActorFromResponse(n.vals),u._logger.info("myActor: ",e._myActor),e.clearActors(),e.addActor(e._myActor),f=n.vals[t.Constants.ParameterCode.ActorList],h=n.vals[t.Constants.ParameterCode.PlayerProperties],f!==undefined)for(c in f)o=f[c],h!==undefined&&(r=h[o]),r!==undefined&&(l=r[t.Constants.ActorProperties.PlayerName]),o==e._myActor.actorNr?s=e._myActor:(s=e.actorFactoryInternal(l,o),e.addActor(s)),r!==undefined&&s._updateCustomProperties(r);e.currentRoom._updateFromProps(n.vals[t.Constants.ParameterCode.GameProperties]);e.changeState(i.State.Joined);e.onJoinRoom(!1)}e._onOperationResponseInternal2(t.Constants.OperationCode.JoinGame,n)});u.addResponseListener(t.Constants.OperationCode.SetProperties,function(n){u._logger.debug("resp SetProperties",n);e._onOperationResponseInternal2(t.Constants.OperationCode.SetProperties,n)});u.addResponseListener(t.Constants.OperationCode.Leave,function(n){u._logger.debug("resp Leave",n);u.disconnect();e._onOperationResponseInternal2(t.Constants.OperationCode.Leave,n)});u.addResponseListener(t.Constants.OperationCode.Rpc,u.webRpcHandler(this));u.addEventListener(t.Constants.EventCode.Join,function(n){if(u._logger.debug("ev Join",n),r._getActorNrFromResponse(n.vals)===e._myActor.actorNr){e._myActor._updateFromResponse(n.vals);e.onActorJoin(e._myActor)}else{var t=e.actorFactoryInternal();t._updateFromResponse(n.vals);e.addActor(t);e.onActorJoin(t)}});u.addEventListener(t.Constants.EventCode.Leave,function(n){var i,f;if(u._logger.debug("ev Leave",n),e.myRoom()._updateFromEvent(n.vals),i=r._getActorNrFromResponse(n.vals),i&&e.actors[i])if(f=e.actors[i],n.vals[t.Constants.ParameterCode.IsInactive]){f._setSuspended(!0);e.onActorSuspend(f)}else{e.removeActor(i);e.onActorLeave(f,!1)}});u.addEventListener(t.Constants.EventCode.Disconnect,function(n){var t,i;if(u._logger.debug("ev Disconnect",n),t=r._getActorNrFromResponse(n.vals),t&&e.actors[t]){i=e.actors[t];i._setSuspended(!0);e.onActorSuspend(i)}});u.addEventListener(t.Constants.EventCode.PropertiesChanged,function(n){var i,r;if(u._logger.debug("ev PropertiesChanged",n),i=n.vals[t.Constants.ParameterCode.TargetActorNr],i!==undefined&&i>0){if(e.actors[i]!==undefined){r=e.actors[i];r._updateCustomProperties(n.vals[t.Constants.ParameterCode.Properties]);e.onActorPropertiesChange(r)}}else e.currentRoom._updateFromProps(n.vals[t.Constants.ParameterCode.Properties]),e.onMyRoomPropertiesChange()})},i.prototype._cleanupNameServerPeerData=function(){},i.prototype._cleanupMasterPeerData=function(){},i.prototype._cleanupGamePeerData=function(){for(var n in this.actors)this.onActorLeave(this.actors[n],!0);this.clearActors();this.addActor(this._myActor)},i.prototype._onOperationResponseInternal2=function(n,t){t.errCode&&this.logger.warn("Operation",n,"error:",t.errMsg,"("+t.errCode+")");this.onOperationResponse(t.errCode,t.errMsg,n,t.vals)},i.prototype._onErrorInternal=function(n,t){this.logger.error("Error:",n,t);this.onError(n,t)},i.prototype.initValidNextState=function(){this.validNextState[i.State.Error]=[i.State.ConnectingToMasterserver,i.State.ConnectingToNameServer];this.validNextState[i.State.Uninitialized]=[i.State.ConnectingToMasterserver,i.State.ConnectingToNameServer];this.validNextState[i.State.ConnectedToNameServer]=[i.State.ConnectingToMasterserver];this.validNextState[i.State.Disconnected]=[i.State.ConnectingToMasterserver,i.State.ConnectingToNameServer];this.validNextState[i.State.ConnectedToMaster]=[i.State.JoinedLobby];this.validNextState[i.State.JoinedLobby]=[i.State.ConnectingToGameserver];this.validNextState[i.State.ConnectingToGameserver]=[i.State.ConnectedToGameserver];this.validNextState[i.State.ConnectedToGameserver]=[i.State.Joined]},i.prototype.checkNextState=function(n,t){t===void 0&&(t=!1);var r=this.validNextState[this.state],u=r&&r.indexOf(n)>=0;if(!u)if(t)this.logger.error("LoadBalancingPeer checkNextState fail: "+i.StateToName(this.state)+" -> "+i.StateToName(n));else throw new Error("LoadBalancingPeer checkNextState fail: "+i.StateToName(this.state)+" -> "+i.StateToName(n));return u},i.StateToName=function(n){return Exitgames.Common.Util.getEnumKeyByValue(i.State,n)},i.JoinMode={Default:0,CreateIfNotExists:1,Rejoin:2},i.PeerErrorCode={Ok:0,MasterError:1001,MasterConnectFailed:1002,MasterConnectClosed:1003,MasterTimeout:1004,MasterEncryptionEstablishError:1005,MasterAuthenticationFailed:1101,GameError:2001,GameConnectFailed:2002,GameConnectClosed:2003,GameTimeout:2004,GameEncryptionEstablishError:2005,GameAuthenticationFailed:2101,NameServerError:3001,NameServerConnectFailed:3002,NameServerConnectClosed:3003,NameServerTimeout:3004,NameServerEncryptionEstablishError:3005,NameServerAuthenticationFailed:3101},i.State={Error:-1,Uninitialized:0,ConnectingToNameServer:1,ConnectedToNameServer:2,ConnectingToMasterserver:3,ConnectedToMaster:4,JoinedLobby:5,ConnectingToGameserver:6,ConnectedToGameserver:7,Joined:8,Disconnected:10},i}();t.LoadBalancingClient=l;f=function(n){function i(){return n!==null&&n.apply(this,arguments)||this}return __extends(i,n),i.prototype.webRpc=function(n,i){var r=[];r.push(t.Constants.ParameterCode.UriPath,n);r.push(t.Constants.ParameterCode.RpcCallParams,i);this.sendOperation(t.Constants.OperationCode.Rpc,r)},i.prototype.webRpcHandler=function(n){var i=this;return function(r){i._logger.debug("resp Rpc",r);var u,f,e;r.errCode==0?(u=r.vals[t.Constants.ParameterCode.UriPath],f=r.vals[t.Constants.ParameterCode.RpcCallRetData],e=r.vals[t.Constants.ParameterCode.RpcCallRetCode]):i._logger.error("WebRpc request error:",r.errCode);n.onWebRpcResult(r.errCode,r.errMsg,u,e,f)}},i}(n.PhotonPeer);t.LbcPeer=f;s=function(i){function r(n,t,r){var u=i.call(this,t,r,"NameServer")||this;return u.client=n,u}return __extends(r,i),r.prototype.onUnhandledEvent=function(n,i){this.client.onEvent(n,i.vals[t.Constants.ParameterCode.CustomEventContent],i.vals[t.Constants.ParameterCode.ActorNr])},r.prototype.onUnhandledResponse=function(n,t){this.client.onOperationResponse(t.errCode,t.errMsg,n,t.vals)},r.prototype.getRegions=function(n){var i=[];i.push(t.Constants.ParameterCode.ApplicationId,n);this.sendOperation(t.Constants.OperationCode.GetRegions,i,!0,0)},r.prototype.opAuth=function(i,r,u,f,e,o,s){var h=[];h.push(t.Constants.ParameterCode.ApplicationId,i);h.push(t.Constants.ParameterCode.AppVersion,r);u!=t.Constants.CustomAuthenticationType.None&&(h.push(t.Constants.ParameterCode.ClientAuthenticationType,n.TypeExt.Byte(u)),h.push(t.Constants.ParameterCode.ClientAuthenticationParams,f),e&&h.push(t.Constants.ParameterCode.ClientAuthenticationData,e));o&&h.push(t.Constants.ParameterCode.UserId,o);h.push(t.Constants.ParameterCode.Region,s);this.sendOperation(t.Constants.OperationCode.Authenticate,h,!0,0);this._logger.info("Authenticate...")},r}(f);t.NameServerPeer=s;h=function(n){function i(t,i,r){var u=n.call(this,i,r,"Master")||this;return u.client=t,u}return __extends(i,n),i.prototype.onUnhandledEvent=function(n,i){this.client.onEvent(n,i.vals[t.Constants.ParameterCode.CustomEventContent],i.vals[t.Constants.ParameterCode.ActorNr])},i.prototype.onUnhandledResponse=function(n,t){this.client.onOperationResponse(t.errCode,t.errMsg,n,t.vals)},i.prototype.findFriends=function(n){var i=[];i.push(t.Constants.ParameterCode.FindFriendsRequestList);i.push(n);this.sendOperation(t.Constants.OperationCode.FindFriends,i)},i.prototype.requestLobbyStats=function(n){var r=[],u,f,i;if(n&&n.length>0){for(u=[],f=[],i=0;i<n.length;++i)u[i]=n[i][0],f[i]=n[i][1];r.push(t.Constants.ParameterCode.LobbyName);r.push(u);r.push(t.Constants.ParameterCode.LobbyType);r.push(f)}this.sendOperation(t.Constants.OperationCode.LobbyStats,r)},i}(f);t.MasterPeer=h;c=function(i){function r(n,t,r){var u=i.call(this,t,r,"Game")||this;return u.client=n,u}return __extends(r,i),r.prototype.onUnhandledEvent=function(n,i){this.client.onEvent(n,i.vals[t.Constants.ParameterCode.CustomEventContent],i.vals[t.Constants.ParameterCode.ActorNr])},r.prototype.onUnhandledResponse=function(n,t){this.client.onOperationResponse(t.errCode,t.errMsg,n,t.vals)},r.prototype.raiseEvent=function(i,r,u){if(this.client.isJoinedToRoom()){this._logger.debug("raiseEvent",i,r,u);var f=[t.Constants.ParameterCode.Code,n.TypeExt.Byte(i),t.Constants.ParameterCode.Data,r];if(u){if(u.receivers!=undefined&&u.receivers!==t.Constants.ReceiverGroup.Others&&(f.push(t.Constants.ParameterCode.ReceiverGroup),f.push(u.receivers)),u.cache!=undefined&&u.cache!==t.Constants.EventCaching.DoNotCache&&(f.push(t.Constants.ParameterCode.Cache),f.push(n.TypeExt.Byte(u.cache))),u.interestGroup!=undefined)if(this.checkGroupNumber(u.interestGroup))f.push(t.Constants.ParameterCode.Group),f.push(n.TypeExt.Byte(u.interestGroup));else throw new Error("raiseEvent - Group not a number: "+u.interestGroup);u.targetActors!=undefined&&(f.push(t.Constants.ParameterCode.ActorList),f.push(u.targetActors));u.webForward&&(f.push(t.Constants.ParameterCode.Forward),f.push(!0))}this.sendOperation(t.Constants.OperationCode.RaiseEvent,f)}else throw new Error("raiseEvent - Not joined!");},r.prototype.changeGroups=function(i,r){var u=[];i!=null&&i!=undefined&&(this.checkGroupArray(i,"groupsToRemove"),u.push(t.Constants.ParameterCode.Remove),u.push(n.TypeExt.Byte(i)));r!=null&&r!=undefined&&(this.checkGroupArray(r,"groupsToAdd"),u.push(t.Constants.ParameterCode.Add),u.push(n.TypeExt.Byte(r)));this.sendOperation(t.Constants.OperationCode.ChangeGroups,u)},r.prototype.checkGroupNumber=function(n){return!(typeof n!="number"||isNaN(n)||n===Infinity||n===-Infinity)},r.prototype.checkGroupArray=function(n,t){var i,r;if(Exitgames.Common.Util.isArray(n)){for(i=0;i<n.length;++i)if(r=n[i],!this.checkGroupNumber(r))throw new Error("changeGroups - "+t+" ("+n+") not an array of numbers: element "+i+" = "+r);}else throw new Error("changeGroups - groupsToRemove not an array: "+n);},r}(f);t.GamePeer=c})(t=n.LoadBalancing||(n.LoadBalancing={}))}(Photon||(Photon={})),function(n){var t;(function(n){var t;(function(n){n.LiteOpKey={ActorList:252,ActorNr:254,ActorProperties:249,Add:238,Broadcast:250,Cache:247,Code:244,Data:245,GameId:255,GameProperties:248,Group:240,Properties:251,ReceiverGroup:246,Remove:239,TargetActorNr:253,EmptyRoomLiveTime:236};n.LiteEventCode={Join:255,Leave:254,PropertiesChanged:253};n.LiteOpCode={ChangeGroups:248,GetProperties:251,Join:255,Leave:254,RaiseEvent:253,SetProperties:252}})(t=n.Constants||(n.Constants={}))})(t=n.Lite||(n.Lite={}))}(Photon||(Photon={})),function(n){var t;(function(t){var i;(function(t){var i=n.Lite.Constants.LiteOpKey,r=n.Lite.Constants.LiteOpCode,u=n.Lite.Constants.LiteEventCode;t.ErrorCode={Ok:0,OperationNotAllowedInCurrentState:-3,InvalidOperationCode:-2,InternalServerError:-1,InvalidAuthentication:32767,GameIdAlreadyExists:32766,GameFull:32765,GameClosed:32764,NoRandomMatchFound:32760,GameDoesNotExist:32758,MaxCcuReached:32757,InvalidRegion:32756};t.ActorProperties={PlayerName:255};t.GameProperties={MaxPlayers:255,IsVisible:254,IsOpen:253,PlayerCount:252,Removed:251,PropsListedInLobby:250,CleanupCacheOnLeave:249,MasterClientId:248};t.EventCode={GameList:230,GameListUpdate:229,QueueState:228,AppStats:226,AzureNodeInfo:210,Join:u.Join,Leave:u.Leave,PropertiesChanged:u.PropertiesChanged,Disconnect:252,LobbyStats:224};t.ParameterCode={Address:230,PeerCount:229,GameCount:228,MasterPeerCount:227,UserId:225,ApplicationId:224,Position:223,MatchMakingType:223,GameList:222,Secret:221,AppVersion:220,AzureNodeInfo:210,AzureLocalNodeId:209,AzureMasterNodeId:208,RoomName:i.GameId,Broadcast:i.Broadcast,ActorList:i.ActorList,ActorNr:i.ActorNr,PlayerProperties:i.ActorProperties,CustomEventContent:i.Data,Data:i.Data,Code:i.Code,GameProperties:i.GameProperties,Properties:i.Properties,TargetActorNr:i.TargetActorNr,ReceiverGroup:i.ReceiverGroup,Cache:i.Cache,CleanupCacheOnLeave:241,Group:i.Group,Remove:i.Remove,Add:i.Add,EmptyRoomTTL:i.EmptyRoomLiveTime,PlayerTTL:235,Plugins:204,ClientAuthenticationType:217,ClientAuthenticationParams:216,ClientAuthenticationData:214,JoinMode:215,MasterClientId:203,FindFriendsRequestList:1,FindFriendsResponseOnlineList:1,FindFriendsResponseRoomIdList:2,LobbyName:213,LobbyType:212,LobbyStats:211,Region:210,IsInactive:233,CheckUserOnJoin:232,ExpectedValues:231,UriPath:209,RpcCallParams:208,RpcCallRetCode:207,RpcCallRetMessage:206,RpcCallRetData:208,Forward:234,Nickname:202};t.OperationCode={Authenticate:230,JoinLobby:229,LeaveLobby:228,CreateGame:227,JoinGame:226,JoinRandomGame:225,Leave:r.Leave,RaiseEvent:r.RaiseEvent,SetProperties:r.SetProperties,GetProperties:r.GetProperties,ChangeGroups:r.ChangeGroups,FindFriends:222,LobbyStats:221,GetRegions:220,Rpc:219};t.MatchmakingMode={FillRoom:0,SerialMatching:1,RandomMatching:2};t.EventCaching={DoNotCache:0,MergeCache:1,ReplaceCache:2,RemoveCache:3,AddToRoomCache:4,AddToRoomCacheGlobal:5,RemoveFromRoomCache:6,RemoveFromRoomCacheForActorsLeft:7};t.ReceiverGroup={Others:0,All:1,MasterClient:2};t.CustomAuthenticationType={Custom:0,Steam:1,Facebook:2,None:255};t.LobbyType={Default:0,SqlLobby:2}})(i=t.Constants||(t.Constants={}))})(t=n.LoadBalancing||(n.LoadBalancing={}))}(Photon||(Photon={})),function(n){var t;(function(n){var t;(function(n){function t(t){return Exitgames.Common.Util.getEnumKeyByValue(n.UserStatus,t)}n.ParameterCode={Channels:0,Channel:1,Messages:2,Message:3,Senders:4,Sender:5,ChannelUserCount:6,UserId:225,MsgId:8,MsgIds:9,SubscribeResults:15,Status:10,Friends:11,SkipMessage:12,HistoryLength:14};n.OperationCode={Subscribe:0,Unsubscribe:1,Publish:2,SendPrivate:3,ChannelHistory:4,UpdateStatus:5,AddFriendds:6,RemoveFriends:7};n.EventCode={ChatMessages:0,Users:1,PrivateMessage:2,FriendsList:3,StatusUpdate:4,Subscribe:5,Unsubscribe:6};n.UserStatus={Offline:0,Invisible:1,Online:2,Away:3,Dnd:4,Lfg:5,Playing:6};n.UserStatusToName=t})(t=n.Constants||(n.Constants={}))})(t=n.Chat||(n.Chat={}))}(Photon||(Photon={})),function(n){var t;(function(t){var i=function(){function n(n,t){this.sender=n;this.content=t}return n.prototype.getSender=function(){return this.sender},n.prototype.getContent=function(){return this.content},n}(),r,u;t.Message=i;r=function(){function n(n,t){this.name=n;this.isPrivat=t;this.messages=[]}return n.prototype.getName=function(){return this.name},n.prototype.isPrivate=function(){return this.isPrivat},n.prototype.getMessages=function(){return this.messages},n.prototype.clearMessages=function(){this.messages.splice(0)},n.prototype.addMessage=function(n){this.messages.push(n)},n.prototype.addMessages=function(n,t){var f=[],r,u;for(r in n)parseInt(r)<t.length&&(u=new i(n[r],t[r]),this.addMessage(u),f.push(u));return f},n}();t.Channel=r;u=function(n){function u(t,i,r){var u=n.call(this,t,i,r)||this;return u.publicChannels={},u.privateChannels={},u.subscribeRequests=[],u.unsubscribeRequests=[],u.autoJoinLobby=!1,u}return __extends(u,n),u.prototype.onStateChange=function(){},u.prototype.onError=function(){},u.prototype.onSubscribeResult=function(){},u.prototype.onUnsubscribeResult=function(){},u.prototype.onChatMessages=function(){},u.prototype.onPrivateMessage=function(){},u.prototype.onUserStatusUpdate=function(){},u.prototype.connectToRegionFrontEnd=function(n){return this.connectToRegionMaster(n)},u.prototype.isConnectedToFrontEnd=function(){return this.state==u.ChatState.ConnectedToFrontEnd},u.prototype.subscribe=function(n,i){if(i===void 0&&(i=0),this.isConnectedToFrontEnd()){this.logger.debug("Subscribe channels:",n);var r=[];return r.push(t.Constants.ParameterCode.Channels,n),i!=undefined&&i!=0&&r.push(t.Constants.ParameterCode.HistoryLength,i),this.masterPeer.sendOperation(t.Constants.OperationCode.Subscribe,r),!0}return this.logger.error("subscribe request error:","Not connected to Front End"),!1},u.prototype.unsubscribe=function(n){if(this.isConnectedToFrontEnd()){this.logger.debug("Unsubscribe channels:",n);var i=[];return i.push(t.Constants.ParameterCode.Channels,n),this.masterPeer.sendOperation(t.Constants.OperationCode.Unsubscribe,i),!0}return this.logger.error("unsubscribe request error:","Not connected to Front End"),!1},u.prototype.publishMessage=function(n,i){if(this.isConnectedToFrontEnd()){var r=[];return r.push(t.Constants.ParameterCode.Channel,n),r.push(t.Constants.ParameterCode.Message,i),this.masterPeer.sendOperation(t.Constants.OperationCode.Publish,r),!0}return this.logger.error("publishMessage request error:","Not connected to Front End"),!1},u.prototype.sendPrivateMessage=function(n,i){if(this.isConnectedToFrontEnd()){var r=[];return r.push(t.Constants.ParameterCode.UserId,n),r.push(t.Constants.ParameterCode.Message,i),this.masterPeer.sendOperation(t.Constants.OperationCode.SendPrivate,r),!0}return this.logger.error("sendPrivateMessage request error:","Not connected to Front End"),!1},u.prototype.setUserStatus=function(n,i,r){if(i===void 0&&(i=null),r===void 0&&(r=!1),this.isConnectedToFrontEnd()){var u=[];return u.push(t.Constants.ParameterCode.Status,n),r?u.push(t.Constants.ParameterCode.SkipMessage,!0):u.push(t.Constants.ParameterCode.Message,i),this.masterPeer.sendOperation(t.Constants.OperationCode.UpdateStatus,u),!0}return this.logger.error("setUserStatus request error:","Not connected to Front End"),!1},u.prototype.addFriends=function(n){if(this.isConnectedToFrontEnd()){var i=[];return i.push(t.Constants.ParameterCode.Friends,n),this.masterPeer.sendOperation(t.Constants.OperationCode.AddFriendds,i),!0}return this.logger.error("addFriends request error:","Not connected to Front End"),!1},u.prototype.removeFriends=function(n){if(this.isConnectedToFrontEnd()){var i=[];return i.push(t.Constants.ParameterCode.Friends,n),this.masterPeer.sendOperation(t.Constants.OperationCode.RemoveFriends,i),!0}return this.logger.error("removeFriends request error:","Not connected to Front End"),!1},u.prototype.getPublicChannels=function(){return this.publicChannels},u.prototype.getPrivateChannels=function(){return this.privateChannels},u.prototype.getOrAddChannel=function(n,t,i){return n[t]==undefined&&(n[t]=new r(t,i)),n[t]},u.prototype.initMasterPeer=function(r){var u=this;n.prototype.initMasterPeer.call(this,r);r.addEventListener(t.Constants.EventCode.ChatMessages,function(n){var o=n.vals[t.Constants.ParameterCode.Senders],s=n.vals[t.Constants.ParameterCode.Messages],i=n.vals[t.Constants.ParameterCode.Channel],f=u.publicChannels[i],e;if(f){e=f.addMessages(o,s);u.onChatMessages(i,e)}else r._logger.warn("ev ChatMessages: Got message from unsubscribed channel ",i)});r.addEventListener(t.Constants.EventCode.PrivateMessage,function(n){var r=n.vals[t.Constants.ParameterCode.Sender],e=n.vals[t.Constants.ParameterCode.Message],o=n.vals[t.Constants.ParameterCode.UserId],f="",s;f=u.getUserId()==r?o:r;s=u.getOrAddChannel(u.privateChannels,f,!0);u.onPrivateMessage(f,new i(r,e))});r.addEventListener(t.Constants.EventCode.StatusUpdate,function(n){var r=n.vals[t.Constants.ParameterCode.Sender],f=n.vals[t.Constants.ParameterCode.Status],i=n.vals[t.Constants.ParameterCode.Message],e=i!==undefined;u.onUserStatusUpdate(r,f,e,i)});r.addEventListener(t.Constants.EventCode.Subscribe,function(n){var i,f;r._logger.debug("ev Subscribe",n);var e={},o=n.vals[t.Constants.ParameterCode.Channels]||[],s=n.vals[t.Constants.ParameterCode.SubscribeResults]||[];for(i in o)f=o[i],e[f]=!1,i<s.length&&s[i]&&(u.getOrAddChannel(u.publicChannels,f,!1),e[f]=!0);u.onSubscribeResult(e)});r.addEventListener(t.Constants.EventCode.Unsubscribe,function(n){var i,f,o,e;r._logger.debug("ev Unsubscribe",n);i={};f=n.vals[t.Constants.ParameterCode.Channels]||[];for(o in f)e=f[o],delete u.publicChannels[e],i[e]=!0;u.onUnsubscribeResult(i)})},u.StateToName=function(n){var t=Exitgames.Common.Util.getEnumKeyByValue(u.ChatState,n);return t===undefined?Exitgames.Common.Util.getEnumKeyByValue(u.State,n):t},u.ChatPeerErrorCode={Ok:0,FrontEndError:1001,FrontEndConnectFailed:1002,FrontEndConnectClosed:1003,FrontEndTimeout:1004,FrontEndEncryptionEstablishError:1005,FrontEndAuthenticationFailed:1101,NameServerError:3001,NameServerConnectFailed:3002,NameServerConnectClosed:3003,NameServerTimeout:3004,NameServerEncryptionEstablishError:300,NameServerAuthenticationFailed:3101},u.ChatState={Error:-1,Uninitialized:0,ConnectingToNameServer:1,ConnectedToNameServer:2,ConnectingToFrontEnd:3,ConnectedToFrontEnd:4,Disconnected:10},u}(n.LoadBalancing.LoadBalancingClient);t.ChatClient=u})(t=n.Chat||(n.Chat={}))}(Photon||(Photon={}))